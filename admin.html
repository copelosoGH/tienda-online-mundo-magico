<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Tienda</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save { background: #25D366; color: white; }
        .btn-save:hover { background: #1da851; }
        .btn-edit-mode { background: #25D366 !important; } /* Color azul para modo edici√≥n */
        .btn-cat { background: #333; color: white; margin-top: 5px; }
        .producto-item, .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .actions { display: flex; gap: 5px; }
        .btn-delete { background: #ff4757; color: white; width: auto; padding: 5px 12px; font-size: 12px; }
        .btn-edit { background: #0080ff; color: white; width: auto; padding: 5px 12px; font-size: 12px; }
        
        #preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
        .thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #25D366; }
        
        h3 { margin-top: 0; border-bottom: 2px solid #f4f4f4; padding-bottom: 10px; }
        .search-box { background: #fffde7; border: 1px solid #fbc02d; margin-bottom: 15px; }
        .edit-notice { background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 10px; display: none; border-left: 5px solid #2196f3; font-size: 14px; }
    </style>
</head>

<body>

    <div class="container">
        <div class="card">
            <h3>üè∑Ô∏è Gestionar Categor√≠as</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="nueva-categoria" placeholder="Ej: Remeras, Pantalones...">
                <button class="btn-cat" onclick="guardarCategoria()" style="width: 120px;">A√±adir</button>
            </div>
            <div id="lista-categorias" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
        </div>

        <div class="card" id="formulario-producto">
            <h3 id="form-title">üõçÔ∏è Agregar Nuevo Producto</h3>
            <div id="edit-notice" class="edit-notice">Est√°s editando un producto. <a href="#" onclick="cancelarEdicion()" style="color: #d32f2f;">Cancelar</a></div>
            
            <input type="text" id="nombre" placeholder="Nombre del producto">
            <textarea id="desc" placeholder="Descripci√≥n breve"></textarea>
            
            <div style="position: relative;">
                <span style="position: absolute; left: 10px; top: 18px; font-weight: bold;">$</span>
                <input type="text" id="precio" placeholder="0.00 (Deja 0 para 'Consultar')" style="padding-left: 25px;">
            </div>

            <label style="font-size: 13px; color: #666;">Selecciona una Categor√≠a:</label>
            <select id="select-categoria">
                <option value="">-- Elige una categor√≠a --</option>
            </select>

            <div id="preview-container"></div>

            <button type="button" id="btn-foto" onclick="abrirSubida()" style="background: #0080ff; margin: 10px 0; color: white;">
                üì∏ Seleccionar Fotos
            </button>

            <button id="btn-principal" class="btn-save" onclick="guardarProducto()">
                üöÄ Publicar Producto
            </button>
        </div>

        <div class="card">
            <h3>Productos en la Web</h3>
            <input type="text" id="buscador" class="search-box" placeholder="üîç Buscar producto por nombre..." onkeyup="filtrarProductos()">
            <div id="lista-admin">Cargando...</div>
        </div>
    </div>

    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- AUTH ---
        if (!sessionStorage.getItem('autenticado')) {
            const password = prompt("Introduce la contrase√±a de administrador:");
            if (password === "Conradop2026") {
                sessionStorage.setItem('autenticado', 'true');
            } else {
                alert("Acceso denegado");
                window.location.href = "index.html";
            }
        }

        const firebaseConfig = {
            apiKey: "AIzaSyBAwajRszUkOGecRCSIgwiEWnpkXjxz3vo",
            authDomain: "tienda-online-81c97.firebaseapp.com",
            projectId: "tienda-online-81c97",
            storageBucket: "tienda-online-81c97.firebasestorage.app",
            messagingSenderId: "977391278715",
            appId: "1:977391278715:web:610fe81e5b2b66237c20de"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const productosRef = collection(db, "productos");
        const categoriasRef = collection(db, "categorias");

        let fotosSubidas = [];
        let productosLocal = [];
        let idEnEdicion = null; // VARIABLE CLAVE PARA EDICI√ìN

        const formatText = (str) => {
            if (!str) return "";
            const limpio = str.trim().toLowerCase();
            return limpio.charAt(0).toUpperCase() + limpio.slice(1);
        };

        const myWidget = cloudinary.createUploadWidget({
            cloudName: 'dpl0ce3va',
            uploadPreset: 'fotos_tienda',
            multiple: true
        }, (error, result) => {
            if (!error && result && result.event === "success") {
                fotosSubidas.push(result.info.secure_url);
                actualizarPreview();
                document.getElementById('btn-foto').innerText = `‚úÖ ${fotosSubidas.length} Foto(s) Listas`;
            }
        });

        function actualizarPreview() {
            const container = document.getElementById('preview-container');
            container.innerHTML = "";
            fotosSubidas.forEach(url => {
                container.innerHTML += `<img src="${url}" class="thumb">`;
            });
        }

        window.abrirSubida = () => myWidget.open();

        // --- CATEGOR√çAS ---
        window.guardarCategoria = async () => {
            const input = document.getElementById('nueva-categoria');
            if (!input.value) return;
            try {
                await addDoc(categoriasRef, { nombre: formatText(input.value) });
                input.value = "";
            } catch (e) { console.error(e); }
        };

        window.eliminarCategoria = async (id) => {
            if (confirm("¬øBorrar categor√≠a?")) await deleteDoc(doc(db, "categorias", id));
        };

        onSnapshot(query(categoriasRef, orderBy("nombre", "asc")), (snapshot) => {
            const listaCat = document.getElementById('lista-categorias');
            const selectCat = document.getElementById('select-categoria');
            listaCat.innerHTML = '';
            selectCat.innerHTML = '<option value="">-- Elige una categor√≠a --</option>';
            snapshot.forEach((docSnap) => {
                const cat = docSnap.data();
                listaCat.innerHTML += `<div class="cat-item"><span>${cat.nombre}</span><button class="btn-delete" onclick="eliminarCategoria('${docSnap.id}')">√ó</button></div>`;
                selectCat.innerHTML += `<option value="${cat.nombre}">${cat.nombre}</option>`;
            });
        });

        // --- PRODUCTOS ---

        // Funci√≥n para cargar datos en el formulario para editar
        window.prepararEdicion = (id) => {
            const p = productosLocal.find(prod => prod.id === id);
            if (!p) return;

            idEnEdicion = id;
            
            // Llenar campos
            document.getElementById('nombre').value = p.nombre;
            document.getElementById('desc').value = p.desc || "";
            document.getElementById('precio').value = p.precio.replace('$', '') === "Consultar" ? "0" : p.precio.replace('$', '');
            document.getElementById('select-categoria').value = p.categoria;
            
            // Cargar fotos actuales
            fotosSubidas = p.imagenes || [p.img];
            actualizarPreview();

            // Cambiar UI
            document.getElementById('form-title').innerText = "‚úèÔ∏è Editando Producto";
            document.getElementById('btn-principal').innerText = "üíæ Guardar Cambios";
            document.getElementById('btn-principal').classList.add('btn-edit-mode');
            document.getElementById('edit-notice').style.display = "block";
            document.getElementById('btn-foto').innerText = `‚úÖ ${fotosSubidas.length} Foto(s) actuales`;

            // Subir al formulario
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelarEdicion = () => {
            idEnEdicion = null;
            document.getElementById('nombre').value = "";
            document.getElementById('desc').value = "";
            document.getElementById('precio').value = "";
            document.getElementById('select-categoria').value = "";
            fotosSubidas = [];
            actualizarPreview();
            
            document.getElementById('form-title').innerText = "üõçÔ∏è Agregar Nuevo Producto";
            document.getElementById('btn-principal').innerText = "üöÄ Publicar Producto";
            document.getElementById('btn-principal').classList.remove('btn-edit-mode');
            document.getElementById('edit-notice').style.display = "none";
            document.getElementById('btn-foto').innerText = "üì∏ Seleccionar Fotos";
        };

        window.guardarProducto = async () => {
            const nomInput = document.getElementById('nombre');
            const descInput = document.getElementById('desc');
            const precInput = document.getElementById('precio');
            const catSelect = document.getElementById('select-categoria');

            if (!nomInput.value || !catSelect.value || fotosSubidas.length === 0) {
                return alert("Nombre, categor√≠a y al menos una foto son obligatorios.");
            }

            let precioFinal = precInput.value.trim();
            if (precioFinal === "" || precioFinal === "0") {
                precioFinal = "Consultar";
            } else {
                precioFinal = "$" + precioFinal;
            }

            const datos = {
                nombre: formatText(nomInput.value),
                desc: formatText(descInput.value),
                precio: precioFinal,
                categoria: catSelect.value,
                imagenes: fotosSubidas,
                img: fotosSubidas[0],
                ultimaModificacion: Date.now()
            };

            try {
                if (idEnEdicion) {
                    // MODO ACTUALIZAR
                    await updateDoc(doc(db, "productos", idEnEdicion), datos);
                } else {
                    // MODO CREAR
                    datos.fecha = Date.now();
                    await addDoc(productosRef, datos);
                }
                cancelarEdicion();
            } catch (e) { 
                console.error(e);
                alert("Error al procesar la solicitud"); 
            }
        };

        window.eliminarProducto = async (id) => {
            if (confirm("¬øBorrar este producto?")) await deleteDoc(doc(db, "productos", id));
        };

        window.filtrarProductos = () => {
            const busqueda = document.getElementById('buscador').value.toLowerCase();
            renderizarLista(productosLocal.filter(p => p.nombre.toLowerCase().includes(busqueda)));
        };

        const renderizarLista = (arr) => {
            const lista = document.getElementById('lista-admin');
            lista.innerHTML = '';
            arr.forEach((p) => {
                lista.innerHTML += `
                <div class="producto-item">
                    <span><strong>${p.nombre}</strong> <small style="color:#888;">(${p.categoria})</small> - ${p.precio}</span>
                    <div class="actions">
                        <button class="btn-edit" onclick="prepararEdicion('${p.id}')">Editar</button>
                        <button class="btn-delete" onclick="eliminarProducto('${p.id}')">Eliminar</button>
                    </div>
                </div>`;
            });
        };

        onSnapshot(query(productosRef, orderBy("nombre", "asc")), (snapshot) => {
            productosLocal = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filtrarProductos();
        });
    </script>
</body>
</html>